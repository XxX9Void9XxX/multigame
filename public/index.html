<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Multiplayer Copter.io</title>
<style>
body { margin:0; overflow:hidden; background:#111; }
canvas { display:block; }
#ui { position:absolute; top:10px; left:10px; color:white; font-family:Arial; }
</style>
</head>
<body>

<div id="ui">WASD to move â€¢ Click to shoot</div>
<canvas id="game"></canvas>

<script src="/socket.io/socket.io.js"></script>
<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
resize();
addEventListener("resize", resize);

const socket = io();

let keys = { w:false, a:false, s:false, d:false };
let mouseAngle = 0;
let cameraX = 0, cameraY = 0;

let state = { players:{}, bullets:[] };

socket.emit("init", {
  name: "Player" + Math.floor(Math.random()*1000),
  color: "#"+Math.floor(Math.random()*16777215).toString(16)
});

addEventListener("keydown", e => {
  if (keys[e.key]) keys[e.key] = true;
});
addEventListener("keyup", e => {
  if (keys[e.key]) keys[e.key] = false;
});

canvas.addEventListener("mousemove", e => {
  mouseAngle = Math.atan2(
    e.clientY - canvas.height/2,
    e.clientX - canvas.width/2
  );
  socket.emit("aim", mouseAngle);
});

canvas.addEventListener("mousedown", () => {
  socket.emit("shoot");
});

setInterval(() => {
  socket.emit("keys", keys);
}, 1000/60);

socket.on("state", s => state = s);

function drawMap() {
  ctx.fillStyle = "#222";
  for (let x = 0; x < 5000; x += 50)
    ctx.fillRect(x - cameraX, -cameraY, 1, 5000);
  for (let y = 0; y < 5000; y += 50)
    ctx.fillRect(-cameraX, y - cameraY, 5000, 1);
}

function drawPlayer(p) {
  ctx.beginPath();
  ctx.fillStyle = p.color;
  ctx.arc(p.x - cameraX, p.y - cameraY, p.r, 0, Math.PI*2);
  ctx.fill();

  ctx.save();
  ctx.translate(p.x - cameraX, p.y - cameraY);
  ctx.rotate(p.angle);
  ctx.fillStyle = "#fff";
  ctx.fillRect(0, -4, 28, 8);
  ctx.restore();

  ctx.fillStyle = "white";
  ctx.font = "12px Arial";
  ctx.textAlign = "center";
  ctx.fillText(p.name, p.x - cameraX, p.y - cameraY - p.r - 8);
}

function loop() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawMap();

  const me = state.players[socket.id];
  if (me) {
    cameraX = me.x - canvas.width/2;
    cameraY = me.y - canvas.height/2;
  }

  for (const id in state.players)
    drawPlayer(state.players[id]);

  ctx.fillStyle = "#ff0";
  state.bullets.forEach(b => {
    ctx.beginPath();
    ctx.arc(b.x - cameraX, b.y - cameraY, 4, 0, Math.PI*2);
    ctx.fill();
  });

  requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>
